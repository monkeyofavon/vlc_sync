import dbus
from gi.repository import GObject
from dbus.mainloop.glib import DBusGMainLoop


class DbusListener():
    def __init__(self, bus, bus_name, object_path, iface_name):
        self.bus_name = bus_name
        self.object_path = object_path
        self.iface_name = iface_name

        self.bus = bus
        self.proxy = None
        self.iface = None

    def connect(self):
        self.proxy = self.bus.get_object(self.bus_name, self.object_path)
        self.iface = dbus.Interface(self.proxy, dbus_interface = self.iface_name)
        self.properties_iface = dbus.Interface(self.proxy, dbus_interface = self.iface_name)

    def listen(self, signal, signal_handler):
        self.iface.connect_to_signal(signal, signal_handler)


class TcpListener():
    def __init__(self):
        pass


class Server():
    def __init__(self):
        pass


class Client():
    def __init__(self):
        pass


class SignalHandler():
    def __init__(self):
        self.bus = dbus.SessionBus()

        self.application_listener = DbusListener(self.bus, 
                                                 'org.freedesktop.DBus', 
                                                 '/org/freedesktop/DBus', 
                                                 'org.freedesktop.DBus')
        self.instance_listener = None      

        self.application_listener.connect()
        self.application_listener.listen('NameOwnerChanged', 
                                         self.__handle_name_owner_changed)

    def __handle_name_owner_changed(self, bus_name, disconnect_id, connect_id):
        if 'org.mpris.MediaPlayer2.vlc-' in bus_name:
            if not self.instance_listener and connect_id:
                self.instance_listener = DbusListener(self.bus, bus_name,
                                                      '/org/mpris/MediaPlayer2',
                                                      'org.freedesktop.DBus.Properties')
                self.instance_listener.connect()
                self.instance_listener.listen('PropertiesChanged',
                                              self.__handle_properties_changed)
                print "connected\t", bus_name
            elif self.instance_listener.bus_name == bus_name and disconnect_id:
                self.instance_listener = None
                print "disconnected\t", bus_name

    def __handle_properties_changed(self, bus_name, message_dict, __ignore):
        if dbus.String(u'PlaybackStatus') in message_dict.keys(): 
            print "playback\t", message_dict[dbus.String(u'PlaybackStatus')]


# class VlcInterface:
#     def __init__(self, bus_name):
#         pass
        
#     def __get_track_id(self):
#         metadata = self.properties_iface.Get(self.player_iface_name, 'Metadata')
#         return metadata[dbus.String(u'mpris:trackid')]
 
#     def jump_to(self, position):
#         try:
#             track_id = self.__get_track_id()
#             self.player_iface.SetPosition(track_id, position)
#         except:
#             return 0
#         return 1

#     def play(self):
#         try:
#             self.player_iface.Play()
#         except:
#             return 0
#         return 1

#     def pause(self):
#         try:
#             self.player_iface.Pause()
#         except:
#             return 0
#         return 1

#     def stop(self):
#         try:
#             self.player_iface.Stop()
#         except:
#             return 0
#         return 1

def main():
    DBusGMainLoop(set_as_default=True)

    signal_handler = SignalHandler()
    
    mainloop = GObject.MainLoop()
    mainloop.run()

if __name__ == '__main__':
    main()
